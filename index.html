<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Êä•ÈîÄÁ≥ªÁªü (V12 ÂèØ‰øÆÊîπÁâà)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        /* ================== Ê†∏ÂøÉÂä®Êïà‰∏éË¥®ÊÑü (‰øùÊåÅ V11 È£éÊ†º) ================== */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", sans-serif; 
            background-color: #F0F2F5; 
            color: #1D1D1F; 
            margin: 0; padding: 0; 
            display: flex; justify-content: center; min-height: 100vh; 
            -webkit-font-smoothing: antialiased;
        }
        
        #root-container {
            width: 100%; max-width: 440px; 
            background: #F5F7FA; 
            height: 100vh; position: relative; overflow: hidden;
            display: flex; flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .list-item-anim {
            animation: slideUpFade 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            opacity: 0; 
        }

        .glass-nav { 
            background: rgba(255, 255, 255, 0.8); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); 
            border-bottom: 1px solid rgba(0,0,0,0.03);
            box-shadow: 0 4px 30px rgba(0,0,0,0.02);
        }

        .text-gradient-dark {
            background: linear-gradient(135deg, #1a1a1a 0%, #4a4a4a 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .text-gradient-green {
            background: linear-gradient(135deg, #059669 0%, #34d399 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        input, select {
            background: #FFFFFF; border: 1px solid #E5E7EB;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        input:focus, select:focus {
            border-color: #3B82F6; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15); transform: translateY(-1px);
        }

        .btn-bounce:active { transform: scale(0.92); }
        .btn-primary {
            background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
        }

        .toggle-checkbox:checked { right: 0; border-color: #2563EB; }
        .toggle-checkbox:checked + .toggle-label { background-color: #2563EB; }
        
        .modal-transition { transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>

<div id="root-container">

    <div id="login-view" class="absolute inset-0 z-50 flex flex-col justify-center px-8 bg-[#F9FAFB] transition-opacity duration-300">
        <div class="mb-12 text-center">
            <div class="inline-block p-4 bg-white rounded-[2rem] shadow-xl mb-6">
                <svg class="w-12 h-12 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </div>
            <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Hello.</h1>
            <p class="text-gray-400 text-sm mt-2 font-medium">Supabase Cloud Sync</p>
        </div>
        <div id="error-banner" class="bg-red-50 border border-red-100 text-red-500 p-4 rounded-2xl text-sm mb-6 text-center hidden shadow-sm"></div>
        <div class="space-y-5">
            <input type="email" id="email" class="w-full p-5 rounded-2xl outline-none text-lg font-medium text-gray-700 placeholder-gray-300" placeholder="Ë¥¶Âè∑" value="hzp15@qq.com">
            <input type="password" id="password" class="w-full p-5 rounded-2xl outline-none text-lg font-medium text-gray-700 placeholder-gray-300" placeholder="ÂØÜÁ†Å">
        </div>
        <button onclick="handleLogin()" id="login-btn" class="w-full btn-primary text-white font-bold py-5 rounded-2xl text-lg mt-10 transition-transform btn-bounce tracking-wide">
            ËøõÂÖ•Á≥ªÁªü
        </button>
    </div>

    <div id="app-view" class="flex-1 flex flex-col hidden h-full bg-[#F5F7FA]">
        
        <header class="glass-nav sticky top-0 z-20 pt-safe flex flex-col transition-all duration-300">
            <div class="px-6 pt-6 pb-2 flex justify-between items-center">
                <div>
                    <div class="text-xs text-gray-400 font-bold tracking-wider uppercase mb-1">Net Balance</div>
                    <div class="text-4xl font-black tracking-tight" id="total-display">
                        ¬•<span id="total-val">0.00</span>
                    </div>
                </div>
                <button onclick="handleLogout()" class="bg-white p-3 rounded-full text-gray-400 shadow-md hover:shadow-lg active:scale-90 transition-all border border-gray-100">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                </button>
            </div>

            <div class="px-6 pb-4 pt-2 flex gap-3 overflow-x-auto no-scrollbar">
                <div class="relative min-w-[5.5rem] shadow-sm rounded-xl">
                    <select id="filter-year" onchange="loadData()" class="w-full appearance-none bg-white rounded-xl py-2 pl-3 pr-6 text-xs font-bold text-gray-600 outline-none border-0 ring-1 ring-gray-100">
                        </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                        <svg class="fill-current h-3 w-3" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
                <div class="relative min-w-[4.5rem] shadow-sm rounded-xl">
                    <select id="filter-month" onchange="loadData()" class="w-full appearance-none bg-white rounded-xl py-2 pl-3 pr-6 text-xs font-bold text-gray-600 outline-none border-0 ring-1 ring-gray-100">
                        <option value="all">ÂÖ®Âπ¥</option>
                        <option value="01">1Êúà</option><option value="02">2Êúà</option><option value="03">3Êúà</option>
                        <option value="04">4Êúà</option><option value="05">5Êúà</option><option value="06">6Êúà</option>
                        <option value="07">7Êúà</option><option value="08">8Êúà</option><option value="09">9Êúà</option>
                        <option value="10">10Êúà</option><option value="11">11Êúà</option><option value="12">12Êúà</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                        <svg class="fill-current h-3 w-3" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
                <div class="relative flex-1 shadow-sm rounded-xl">
                    <select id="filter-project" onchange="loadData()" class="w-full appearance-none bg-white rounded-xl py-2 pl-3 pr-8 text-xs font-bold text-gray-600 outline-none border-0 ring-1 ring-gray-100">
                        <option value="">ÂÖ®ÈÉ®È°πÁõÆ</option>
                        </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                        <svg class="fill-current h-3 w-3" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
            </div>
        </header>

        <main id="tx-list" class="flex-1 overflow-y-auto p-5 space-y-6 pb-36 no-scrollbar">
            </main>

        <div class="absolute bottom-10 right-6 z-30 pb-safe">
            <button onclick="openModal()" class="w-16 h-16 btn-primary rounded-full flex items-center justify-center text-white btn-bounce shadow-2xl transition-all hover:-translate-y-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4" />
                </svg>
            </button>
        </div>
    </div>

    <div id="modal-overlay" class="absolute inset-0 bg-gray-900/20 z-40 hidden opacity-0 transition-opacity backdrop-blur-sm" onclick="closeModal()"></div>
    <div id="add-modal" class="absolute bottom-0 left-0 right-0 bg-[#FFFFFF] rounded-t-[2.5rem] z-50 modal-transition translate-y-full h-[90%] flex flex-col shadow-[0_-10px_40px_rgba(0,0,0,0.1)] pb-safe">
        
        <div class="px-8 py-6 flex justify-between items-center bg-white rounded-t-[2.5rem]">
            <button onclick="closeModal()" class="text-gray-400 text-sm font-bold tracking-wider hover:text-gray-600 transition btn-bounce">ÂèñÊ∂à</button>
            <div class="text-lg font-bold text-gray-800" id="modal-title">ËÆ∞‰∏ÄÁ¨î</div>
            <button onclick="submitData()" class="text-blue-600 font-bold text-sm tracking-wider hover:text-blue-700 transition btn-bounce" id="save-btn">‰øùÂ≠ò</button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-8">
            <div class="text-center py-4">
                <div class="flex justify-center items-baseline text-gray-900">
                    <span class="text-3xl font-bold mr-2 text-gray-300">¬•</span>
                    <input type="number" id="amt" class="w-full text-center text-6xl font-black bg-transparent border-none shadow-none outline-none placeholder-gray-200 focus:shadow-none" placeholder="0">
                </div>
                <div class="text-xs text-gray-400 font-bold tracking-widest uppercase mt-2">Amount</div>
            </div>

            <div class="bg-gray-100 p-1.5 rounded-2xl flex shadow-inner">
                <button onclick="setType('expense')" id="btn-expense" class="flex-1 py-3.5 rounded-xl text-xs font-bold bg-white text-gray-900 shadow-md transition-all tracking-wide">ÊîØÂá∫</button>
                <button onclick="setType('income')" id="btn-income" class="flex-1 py-3.5 rounded-xl text-xs font-bold text-gray-400 transition-all tracking-wide">ÂÖ•Ë¥¶</button>
            </div>

            <div class="space-y-4">
                <div class="bg-gray-50 rounded-2xl p-1 border border-gray-100">
                    <div class="flex items-center px-5 py-4 border-b border-gray-200/60">
                        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-4 text-blue-600"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></div>
                        <input type="text" id="desc" class="flex-1 bg-transparent border-none shadow-none text-lg font-medium text-gray-900 placeholder-gray-400 focus:shadow-none text-right" placeholder="‰∫ãÁî± (ÂøÖÂ°´)">
                    </div>
                    <div class="flex items-center px-5 py-4 border-b border-gray-200/60">
                        <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center mr-4 text-purple-600"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></div>
                        <input type="date" id="date" class="flex-1 bg-transparent border-none shadow-none text-lg font-bold text-gray-900 focus:shadow-none text-right font-mono tracking-tighter">
                    </div>
                    <div class="flex items-center px-5 py-4">
                        <div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center mr-4 text-orange-600"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg></div>
                        <input type="text" id="project" class="flex-1 bg-transparent border-none shadow-none text-lg font-medium text-gray-900 placeholder-gray-400 focus:shadow-none text-right" placeholder="È°πÁõÆ (ÈÄâÂ°´)">
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-5 flex justify-between items-center border border-gray-100 shadow-sm">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center mr-4 text-indigo-600"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064"></path></svg></div>
                        <span class="font-bold text-gray-700">ÊòØÂê¶Âá∫Â∑Æ</span>
                    </div>
                    <div class="relative inline-block w-12 h-7 align-middle select-none">
                        <input type="checkbox" id="trip-toggle" class="toggle-checkbox absolute block w-7 h-7 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-200 transition-all duration-300 ease-in-out left-0"/>
                        <label for="trip-toggle" class="toggle-label block overflow-hidden h-7 rounded-full bg-gray-200 cursor-pointer transition-colors duration-300 ease-in-out"></label>
                    </div>
                </div>
            </div>
            <div class="h-24"></div>
        </div>
    </div>

</div>

<script>
    const MY_SUPABASE_URL = 'https://bdlvpffunkbbgdoyqyyn.supabase.co';
    const MY_SUPABASE_KEY = 'sb_publishable_kr3xnYLybVeg4j942H-3HQ_guPabQIL';

    let sb = null;
    let currentType = 'expense';
    let uid = null;
    let cachedList = []; // ÁºìÂ≠òÊï∞ÊçÆÁî®‰∫éÊü•Êâæ
    let editingId = null; // ÂΩìÂâçÊ≠£Âú®ÁºñËæëÁöÑIDÔºåÁ©∫Âàô‰∏∫Êñ∞Â¢û

    const yearSelect = document.getElementById('filter-year');
    const currentYear = new Date().getFullYear();
    for (let i = currentYear; i >= currentYear - 3; i--) {
        const opt = document.createElement('option'); opt.value = i; opt.innerText = i; yearSelect.appendChild(opt);
    }
    document.getElementById('filter-month').value = (new Date().getMonth() + 1).toString().padStart(2, '0');
    document.getElementById('date').value = new Date().toISOString().split('T')[0];

    window.onload = async () => {
        if (!window.supabase) return;
        try {
            sb = window.supabase.createClient(MY_SUPABASE_URL, MY_SUPABASE_KEY);
            const { data } = await sb.auth.getSession();
            if (data.session) enterApp(data.session);
            sb.auth.onAuthStateChange((e, s) => { if(s) enterApp(s); else showLogin(); });
        } catch(e) { console.error(e); }
    };

    function showLogin() {
        document.getElementById('login-view').classList.remove('hidden');
        document.getElementById('app-view').classList.add('hidden');
    }
    function enterApp(session) {
        document.getElementById('login-view').classList.add('hidden');
        document.getElementById('app-view').classList.remove('hidden');
        uid = session.user.id;
        initProjectFilter().then(() => loadData());
    }

    async function handleLogin() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const btn = document.getElementById('login-btn');
        const banner = document.getElementById('error-banner');
        if (!email || !password) return alert("ËØ∑ËæìÂÖ•ÂÆåÊï¥");
        btn.disabled = true; btn.innerText = "Ê≠£Âú®È™åËØÅ..."; banner.classList.add('hidden');
        if (!sb) sb = window.supabase.createClient(MY_SUPABASE_URL, MY_SUPABASE_KEY);
        try {
            const { error } = await sb.auth.signInWithPassword({ email, password });
            if (error) throw error;
        } catch (e) {
            btn.disabled = false; btn.innerText = "ËøõÂÖ•Á≥ªÁªü";
            banner.innerText = e.message; banner.classList.remove('hidden');
        }
    }

    async function handleLogout() {
        if(confirm("Á°ÆÂÆöÈÄÄÂá∫ÁôªÂΩïÔºü")) { await sb.auth.signOut(); showLogin(); }
    }

    async function initProjectFilter() {
        const { data, error } = await sb.from('transactions').select('project_name').not('project_name', 'is', null);
        if(error || !data) return;
        const projects = [...new Set(data.map(item => item.project_name))];
        const select = document.getElementById('filter-project');
        select.innerHTML = '<option value="">ÂÖ®ÈÉ®È°πÁõÆ</option>';
        projects.forEach(p => {
            if(p && p.trim() !== '') {
                const opt = document.createElement('option'); opt.value = p; opt.innerText = p; select.appendChild(opt);
            }
        });
    }

    async function loadData() {
        const year = document.getElementById('filter-year').value;
        const month = document.getElementById('filter-month').value;
        const project = document.getElementById('filter-project').value;
        
        let start, end;
        if (month === 'all') {
            start = `${year}-01-01`; end = `${parseInt(year)+1}-01-01`;
        } else {
            start = `${year}-${month}-01`;
            let nextM = parseInt(month) + 1, nextY = parseInt(year);
            if(nextM > 12) { nextM = 1; nextY++; }
            end = `${nextY}-${nextM.toString().padStart(2,'0')}-01`;
        }

        let query = sb.from('transactions').select('*').gte('date', start).lt('date', end)
            .order('date', {ascending: false}).order('created_at', {ascending: false});

        if(project) query = query.eq('project_name', project);

        const { data, error } = await query;
        if (error) return console.error(error);
        cachedList = data; // ÁºìÂ≠òÊï∞ÊçÆ‰æõÁºñËæë‰ΩøÁî®
        renderList(data);
    }

    function renderList(list) {
        const container = document.getElementById('tx-list');
        const total = list.reduce((sum, item) => {
            const val = Number(item.amount);
            if (item.type === 'expense') return sum + val;
            if (item.type === 'income') return sum - val;
            return sum;
        }, 0);

        const totalDisplay = document.getElementById('total-display');
        const valSpan = document.getElementById('total-val');
        
        valSpan.innerText = Math.abs(total).toFixed(2); 
        if (total >= 0) {
            totalDisplay.className = "text-4xl font-black tracking-tight text-gradient-dark";
            totalDisplay.innerHTML = `¬•<span id="total-val">${total.toFixed(2)}</span>`;
        } else {
            totalDisplay.className = "text-4xl font-black tracking-tight text-gradient-green";
            totalDisplay.innerHTML = `-¬•<span id="total-val">${Math.abs(total).toFixed(2)}</span>`;
        }

        if (list.length === 0) {
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center mt-32 opacity-40 list-item-anim">
                    <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4 text-3xl">üçÉ</div>
                    <div class="text-sm font-bold text-gray-400 tracking-widest uppercase">No Records</div>
                </div>`;
            return;
        }

        const groups = {};
        list.forEach(item => { if(!groups[item.date]) groups[item.date] = []; groups[item.date].push(item); });

        let html = '';
        let delayIndex = 0;

        for (const date in groups) {
            const dateObj = new Date(date);
            const dayStr = `${dateObj.getMonth()+1}Êúà${dateObj.getDate()}Êó•`;
            const weekDay = "Âë®" + "Êó•‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠".charAt(dateObj.getDay());
            
            html += `<div class="mb-8 list-item-anim" style="animation-delay: ${delayIndex * 0.05}s">
                <div class="flex items-baseline px-4 mb-3">
                    <div class="text-xl font-bold mr-2 text-gray-800">${dayStr}</div>
                    <div class="text-xs text-gray-400 font-bold uppercase tracking-wide">${weekDay}</div>
                </div>
                <div class="bg-white rounded-3xl overflow-hidden shadow-[0_10px_30px_rgba(0,0,0,0.04)] border border-gray-50">`;
            
            delayIndex++;

            groups[date].forEach((item, idx) => {
                const isInc = item.type === 'income';
                const color = isInc ? 'text-emerald-500' : 'text-gray-900';
                const sign = isInc ? '-' : '+';
                
                let tags = '';
                if(item.is_business_trip) tags += `<span class="bg-blue-50 text-blue-600 text-[10px] px-2 py-0.5 rounded-md font-bold ml-2 border border-blue-100 tracking-wide">Âá∫Â∑Æ</span>`;
                if(item.project_name) tags += `<span class="bg-orange-50 text-orange-600 text-[10px] px-2 py-0.5 rounded-md font-bold ml-2 border border-orange-100 tracking-wide">${item.project_name}</span>`;

                html += `
                    <div class="relative group cursor-pointer btn-bounce transition-colors active:bg-gray-50" onclick="editTx('${item.id}')">
                        <div class="flex justify-between items-center p-5">
                            <div class="flex-1 overflow-hidden mr-4">
                                <div class="flex items-center flex-wrap">
                                    <span class="font-bold text-[16px] text-gray-700">${item.description}</span>
                                    ${tags}
                                </div>
                            </div>
                            <div class="font-bold text-lg ${color} flex-shrink-0 font-mono tracking-tight">${sign}${Number(item.amount).toFixed(2)}</div>
                        </div>
                        <button onclick="deleteTx(event, '${item.id}')" class="absolute right-0 top-0 bottom-0 w-20 flex items-center justify-center text-red-500 z-10 opacity-0 hover:opacity-100 transition-all duration-300 bg-gradient-to-l from-white via-white/90 to-transparent">
                            <div class="w-8 h-8 rounded-full bg-red-50 flex items-center justify-center shadow-sm border border-red-100">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </div>
                        </button>
                    </div>
                    ${idx < groups[date].length - 1 ? '<div class="h-[1px] bg-gray-100 ml-5 mr-5"></div>' : ''}
                `;
            });
            html += `</div></div>`;
        }
        container.innerHTML = html;
    }

    async function deleteTx(event, id) {
        event.stopPropagation();
        if(!confirm("Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÂêóÔºü")) return;
        const { error } = await sb.from('transactions').delete().eq('id', id);
        if(error) alert("Âà†Èô§Â§±Ë¥•");
        else initProjectFilter().then(() => loadData());
    }

    // --- ‰øÆÊîπÔºöËøõÂÖ•ÁºñËæëÊ®°Âºè ---
    function editTx(id) {
        const item = cachedList.find(i => i.id === id);
        if(!item) return;

        editingId = id; // Ê†áËÆ∞Ê≠£Âú®ÁºñËæë
        document.getElementById('modal-title').innerText = "‰øÆÊîπËÆ∞ÂΩï";
        document.getElementById('amt').value = item.amount;
        document.getElementById('desc').value = item.description;
        document.getElementById('date').value = item.date;
        document.getElementById('project').value = item.project_name || '';
        document.getElementById('trip-toggle').checked = item.is_business_trip;
        
        setType(item.type);
        openModal(false); // ‰∏çÈáçÁΩÆË°®Âçï
    }

    // --- ‰øÆÊîπÔºöÊèê‰∫§ÈÄªËæë ---
    async function submitData() {
        const amt = document.getElementById('amt').value;
        const desc = document.getElementById('desc').value;
        if (!amt || !desc) return alert("ËØ∑Â°´ÂÜôÂÆåÊï¥‰ø°ÊÅØ");
        
        const btn = document.getElementById('save-btn'); 
        btn.innerText = "‰øùÂ≠ò‰∏≠...";
        btn.disabled = true;

        const payload = {
            amount: amt, description: desc, type: currentType,
            date: document.getElementById('date').value,
            project_name: document.getElementById('project').value || null,
            is_business_trip: document.getElementById('trip-toggle').checked,
            user_id: uid
        };

        let error;
        if (editingId) {
            // Êõ¥Êñ∞ÈÄªËæë
            const res = await sb.from('transactions').update(payload).eq('id', editingId);
            error = res.error;
        } else {
            // Êñ∞Â¢ûÈÄªËæë
            const res = await sb.from('transactions').insert(payload);
            error = res.error;
        }

        btn.disabled = false;
        btn.innerText = "‰øùÂ≠ò";

        if (error) alert("ÈîôËØØ: " + error.message);
        else {
            closeModal(); 
            initProjectFilter().then(() => loadData());
        }
    }

    function setType(type) {
        currentType = type;
        const btnExp = document.getElementById('btn-expense');
        const btnInc = document.getElementById('btn-income');
        if (type === 'expense') {
            btnExp.className = "flex-1 py-3.5 rounded-xl text-xs font-bold bg-white text-gray-900 shadow-md transition-all tracking-wide transform scale-105";
            btnInc.className = "flex-1 py-3.5 rounded-xl text-xs font-bold text-gray-400 transition-all tracking-wide bg-transparent shadow-none";
        } else {
            btnInc.className = "flex-1 py-3.5 rounded-xl text-xs font-bold bg-white text-emerald-600 shadow-md transition-all tracking-wide transform scale-105";
            btnExp.className = "flex-1 py-3.5 rounded-xl text-xs font-bold text-gray-400 transition-all tracking-wide bg-transparent shadow-none";
        }
    }

    function openModal(isNew = true) { 
        if (isNew) {
            editingId = null; // ÈáçÁΩÆ‰∏∫Êñ∞Â¢ûÊ®°Âºè
            document.getElementById('modal-title').innerText = "ËÆ∞‰∏ÄÁ¨î";
            document.getElementById('amt').value = '';
            document.getElementById('desc').value = '';
            document.getElementById('project').value = '';
            document.getElementById('trip-toggle').checked = false;
            // Êó•ÊúüÈªòËÆ§‰ªäÂ§©
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            setType('expense');
        }
        document.getElementById('modal-overlay').classList.remove('hidden'); 
        setTimeout(() => { 
            document.getElementById('modal-overlay').classList.remove('opacity-0'); 
            document.getElementById('add-modal').classList.remove('translate-y-full'); 
        }, 10); 
        if(isNew) setTimeout(()=> document.getElementById('amt').focus(), 300); 
    }

    function closeModal() { 
        document.getElementById('add-modal').classList.add('translate-y-full'); 
        document.getElementById('modal-overlay').classList.add('opacity-0'); 
        setTimeout(() => { document.getElementById('modal-overlay').classList.add('hidden'); }, 300); 
    }
</script>
</body>
</html>
